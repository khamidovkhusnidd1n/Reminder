{% extends "layout.html" %}

{% block content %}
<div class="animate-fade-in game-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1>Game Mode</h1>
        <div class="glass-card" style="padding: 0.5rem 1.5rem; display: flex; gap: 1.5rem; font-weight: 600;">
            <span style="color: var(--secondary)"><i class="fas fa-gem"></i> XP: <span id="xp-val">{{ user.xp if user
                    else 0 }}</span></span>
            <span style="color: #f59e0b"><i class="fas fa-fire"></i> Streak: <span id="streak-val">{{ user.streak if
                    user else 0 }}</span>x</span>
        </div>
    </div>

    <div class="glass-card quiz-card" id="quiz-box">
        {% if quiz %}
        <div id="question-container">
            <h2
                style="font-size: 1.2rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 1rem;">
                Translate:</h2>
            <h3 style="font-size: 3rem; margin-bottom: 2rem; color: white;">{{ quiz.word.word }}</h3>

            <div class="options-grid">
                <button class="option-btn" onclick="submitAnswer('a')">A) {{ quiz.option_a }}</button>
                <button class="option-btn" onclick="submitAnswer('b')">B) {{ quiz.option_b }}</button>
                <button class="option-btn" onclick="submitAnswer('c')">C) {{ quiz.option_c }}</button>
                <button class="option-btn" onclick="submitAnswer('d')">D) {{ quiz.option_d }}</button>
            </div>
        </div>
        {% else %}
        <div style="text-align: center;">
            <i class="fas fa-lock" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem;"></i>
            <h2>Testlar mavjud emas</h2>
            <p>Iltimos, avval so'zlar va testlar qo'shing.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
    async function submitAnswer(option) {
        const quizId = "{{ quiz.id if quiz else 0 }}";
        if (!quizId) return;

        const formData = new FormData();
        formData.append('quiz_id', quizId);
        formData.append('answer', option);

        try {
            const response = await fetch('/api/game/answer', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            const quizBox = document.getElementById('quiz-box');
            if (result.correct) {
                quizBox.style.borderColor = 'var(--accent)';
                quizBox.innerHTML = `
                <div class="animate-fade-in" style="text-align: center;">
                    <i class="fas fa-check-circle" style="font-size: 5rem; color: var(--accent); margin-bottom: 2rem;"></i>
                    <h2 style="font-size: 2.5rem; margin-bottom: 1rem;">To'g'ri!</h2>
                    <p style="font-size: 1.2rem; color: var(--text-muted); margin-bottom: 2rem;">+${result.xp_gain} XP qo'shildi</p>
                    <button class="btn btn-primary" onclick="location.reload()">Keyingi savol <i class="fas fa-arrow-right"></i></button>
                </div>
            `;
            } else {
                quizBox.style.borderColor = 'var(--secondary)';
                quizBox.innerHTML = `
                <div class="animate-fade-in" style="text-align: center;">
                    <i class="fas fa-times-circle" style="font-size: 5rem; color: var(--secondary); margin-bottom: 2rem;"></i>
                    <h2 style="font-size: 2.5rem; margin-bottom: 1rem;">Noto'g'ri</h2>
                    <p style="margin-bottom: 0.5rem;">To'g'ri javob: <b>${result.correct_option}) ${result.correct_text}</b></p>
                    <p style="font-size: 1rem; color: var(--text-muted); margin-bottom: 2rem;">Streak 0 ga tushdi</p>
                    <button class="btn btn-primary" onclick="location.reload()">Qayta urinish</button>
                </div>
            `;
            }

            document.getElementById('xp-val').innerText = result.new_xp;
            document.getElementById('streak-val').innerText = result.new_streak;

        } catch (e) {
            console.error(e);
            alert('Xatolik yuz berdi');
        }
    }
</script>
{% endblock %}